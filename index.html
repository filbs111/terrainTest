<html>

<head>

<title>WebGL Terrain Test</title>

<link rel='stylesheet' type='text/css' media='screen' href='main.css'>

<script id="shader-simple-vs" type="x-shader/x-vertex">

	attribute vec3 aVertexPosition;
	attribute vec3 aVertexMorph;
	attribute vec2 aVertexGradient;
	attribute vec2 aVertexGradientMorph;
	//attribute vec3 aVertexNormal;
	uniform mat4 uMVMatrix;
	uniform mat4 uPMatrix;
	uniform vec2 uCentrePos;
	uniform float uMorphScale;
	varying vec3 vColor;
	
	void main(void) {

		vec2 absDist = abs(aVertexPosition.xy - uCentrePos);

		//Chebyshev distance
		float distFromCentre = max(absDist.x, absDist.y);
		//float transitionRange = 128.0*uMorphScale;
		//float transitionRangeB = 96.0*uMorphScale;	//lowest possible, for 
		//float transitionWidth = 32.0*uMorphScale;	//greatest possible transition width

		float transitionRangeB = 112.0*uMorphScale;	//push transition out further
		float transitionWidth = 16.0*uMorphScale;

		float morphContinuous = clamp((distFromCentre - transitionRangeB)/ transitionWidth , 0.0, 1.0);

		vec2 modvec = mod(aVertexPosition.xy - vec2(uMorphScale) , 2.0*uMorphScale) - vec2(uMorphScale);
		modvec/=uMorphScale;	//normalise
		float lensq = dot(modvec, modvec);
		float stepped = step(0.1, lensq);	//number doesn't matter much
		float blendAmount = stepped*morphContinuous;

		vec3 vertexBlended = blendAmount*aVertexMorph + (1.0-blendAmount)*aVertexPosition;
		vec2 gradBlended = blendAmount*aVertexGradientMorph + (1.0-blendAmount)*aVertexGradient;
		
		
		vec4 transformedCoord = uMVMatrix * vec4(vertexBlended,1.0);	//todo use 4x3 mat?
		gl_Position = uPMatrix * transformedCoord;	
		
		//vColor= vec3(1.0,0.0,0.0);
		//vColor= aVertexPosition;
		
		//vColor= stepped*morphContinuous* vec3(0.5+50.0*gradBlended.x, 0.5+50.0*gradBlended.y, 1.0);	//debug dark overlay
		vColor= vec3(0.5+50.0*gradBlended.x, 0.5+50.0*gradBlended.y, 1.0);

		//vColor= vec3(0.5+20.0*aVertexGradient.x);
	}
</script>

<script id="shader-simple-fs" type="x-shader/x-fragment">
	precision mediump float;
	varying vec3 vColor;

	void main(void){
		//gl_FragColor=vec4(vec3(10.0*vColor.z + 0.1),1.0);
		gl_FragColor=vec4(vColor, 1.0);
	}
</script>


</head>
<body>


<div id="container">
	<canvas class="canvas" id="mycanvas"></canvas>
	<canvas class="canvas" id="mycanvasoverlay"></canvas>
</div>
<div id="container2">
	<canvas id="myglcanvas"></canvas>
</div>

<div><p>auto move</p><input type="checkbox" id="automove"></div>
<div><p>brute force</p><input type="checkbox" id="bruteforce"></div>

<!--only relevant if downscale is checked, default (0) should be same as if downscale not checked-->
<div><input type="range" min="0" max="5" step="1" value="0" id="scaleslider"></div>

<script type="text/javascript" src="lib/stats.min.js"></script>
<script type="text/javascript" src="utils/optional_stats.js"></script>
<script type="text/javascript" src="lib/gl-matrix-min.js"></script>
<script type="text/javascript" src="utils/webgl_utils.js"></script>
<script type="text/javascript" src='utils/keys.js'></script>
<script type="text/javascript" src="utils/downsize_mapping.js"></script>
<script type="text/javascript" src="utils/terrain_utils.js"></script>
<script type="text/javascript" src="utils/quadtree_util.js"></script>
<script type="text/javascript" src="js/main.js"></script>

</html>